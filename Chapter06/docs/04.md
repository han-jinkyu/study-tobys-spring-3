# 4. 스프링의 프록시 팩토리 빈

## 4.1 ProxyFactoryBean

- 스프링은 프록시 오브젝트를 생성해주는 기술을 추상화한 팩토리 빈을 제공한다.
- `ProxyFactoryBean`은 순수하게 프록시를 생성하는 작업만 담당하고 프록시를 통해 제공해줄 부가기능은 별도의 빈에 둘 수 있다.
- `ProxyFactoryBean`이 생성할 부가기능은 `MethodInterceptor` 인터페이스를 구현해 만든다.
- `MethodInterceptor`는 `InvocationHandler`와 유사하지만 `invoke()` 메서드에서 타깃 오브젝트에 대한 정보도 함께 제공 받는다.
- 이 차이는 `MethodInterceptor`가 타깃 오브젝트에 상관 없이 독립적으로 만들어질 수 있게 한다.

```java
public class DynamicProxyTest {
    // ...

    @Test
    public void proxyFactoryBean() {
        ProxyFactoryBean pfBean = new ProxyFactoryBean();
        pfBean.setTarget(new HelloTarget());
        pfBean.addAdvice(new UppercaseAdvice());

        Hello proxiedHello = (Hello) pfBean.getObject();

        assertThat(proxiedHello.sayHello("Toby"), is("HELLO TOBY"));
        assertThat(proxiedHello.sayHi("Toby"), is("HI TOBY"));
        assertThat(proxiedHello.sayThankYou("Toby"), is("THANK YOU TOBY"));
    }

    private class UppercaseAdvice implements MethodInterceptor {
        @Override
        public Object invoke(MethodInvocation methodInvocation) throws Throwable {
            String ret = (String)methodInvocation.proceed();
            return ret.toUpperCase();
        }
    }

    // ...
}
```

### 어드바이스: 타깃이 필요 없는 순수한 부가기능

- `MethodInterceptor`를 구현한 `UppercaseAdvice`는 타깃 오브젝트가 없다.
- `MethodInterceptor`로는 메서드 정보와 타깃 오브젝트가 담긴 `MethodInvocation` 오브젝트가 전달된다.
- `MethodInvocation`는 타깃 오브젝트의 메서드를 실행할 수 있는 기능이 있어서 부가기능을 제공하는 데만 집중할 수 있다.
- `MethodInvocation`은 일종의 콜백 오브젝트로, `proceed()` 메서드를 실행하면 타깃 오브젝트의 메서드를 내부적으로 실행해주는 기능이 있다.
- `ProxyFactoryBean`은 작은 단위의 탬플릿/콜백 구조를 적용했기 때문에, 템플릿 역할을 하는 `MethodInvocation`을 싱글톤으로 두고 공유할 수 있다.
- `ProxyFactoryBean`에 `MethodInterceptor`를 설정할 때 `addAdvice()`를 이용한다. 이는 `ProxyFactoryBean` 하나로 여러 가지 부가기능을 제공하는 프록시를 만들 수 있다는 의미다.
- `MethodInterceptor`처럼 **타깃 오브젝트에 적용할 부가기능을 담은 오브젝트**를 스프링에선 `어드바이스(Advice)`라고 부른다.
- `ProxyFactoryBean`도 구현해야 할 인터페이스 타입을 지정할 수 있다. 다만 알려주지 않아도 자동으로 타입을 알아낸다.

---
[목록](./index.md)
