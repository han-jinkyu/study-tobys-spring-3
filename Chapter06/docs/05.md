# 5. 스프링 AOP

- 지금까지 해온 작업의 목표는 비즈니스 로직에서 반복적으로 등장한 트랜잭션 로직을 깔끔하고 효과적으로 분리해낸 것이다.
- 이렇게 분리해낸 코드는 적용한 후에도 기존 설계와 코드에 아무런 영향을 주지 않아야 한다.

## 5.1 자동 프록시 생성

- 아직 해결할 과제가 있는데, 부가기능의 적용이 필요한 타깃 오브젝트마다 거의 비슷한 내용의 `ProxyFactoryBean` 빈 설정정보를 추가해야 하는 점이다.

### 중복 문제의 접근 방법

- 반복적인 `ProxyFactoryBean` 설정 문제는 설정 자동등록 기법으로 해결할 수 있는가?
- 하지만 지금까지 살펴본 방법에서는 한 번에 여러 개의 빈에 프록시를 적용할 만한 방법은 없었다.

### 빈 후처리기를 이용한 자동 프록시 생성기

- 스프링은 OCP의 가장 중요한 요소인 유연한 확장이라는 개념을 스프링 컨테이너 자신에게도 다양한 방법으로 적용하고 있다.
- 스프링은 컨테이너로서 제공하는 기능 중에서 변하지 않는 핵심 부분 외에는 대부분 확장할 수 있도록 **확장 포인트**를 제공한다.
- 그 중에서 관심을 가질 만한 확장 포인트는 `BeanPostProcessor` 인터페이스를 구현해서 만드는 빈 후처리기다.
- 빈 후처리기 중 하나인 `DefaultAdvisorAutoProxyCreator`를 살펴본다.
- 빈 후처리기 자체를 빈으로 등록하면 간단히 스프링에 적용할 수 있다.
- 빈 후처리기가 등록되어 있다면 스프링은 빈 오브젝트를 만들 때마다 빈을 보낸다. 빈으로 등록된 모든 어드바이저 내 포인트컷을 이용해 전달받은 빈이 프록시 적용 대상인지 확인하고, 적용 대상이면 프록시를 생성하여 어드바지어와 연결해준다. 그리고 컨테이너에 되돌려준다.
- 이를 이용하면 일일이 `ProxyFactoryBean`을 등록하지 않아도 자동으로 프록시가 적용되게 할 수 있다.

### 확장된 포인트컷

- 포인트컷은 두 가지 기능을 가지고 있다. **메서드 선정**과 **빈 오브젝트 자체를 선정**하는 기능이다.

```java
public interface Pointcut {
    ClassFilter getClassFilter();
    MethodMatcher getMethodMatcher();
}
```

### 포인트컷 테스트

- 포인트컷의 기능을 간단한 학습 테스트로 확인해본다.

```java
public class DynamicProxyTest {
    // ...
    @Test
    public void classNamePointcutAdvisor() {
        NameMatchMethodPointcut classMethodPointcut = new NameMatchMethodPointcut() {
            @Override
            public ClassFilter getClassFilter() {
                return clazz -> clazz.getSimpleName().startsWith("HelloT");
            }
        };
        classMethodPointcut.setMappedName("sayH*");

        // 테스트
        checkAdviced(new HelloTarget(), classMethodPointcut, true);

        class HelloWorld extends HelloTarget {};    // HelloT로 시작하는 클래스가 아니기에 필터링됨
        checkAdviced(new HelloWorld(), classMethodPointcut, false);

        class HelloToby extends HelloTarget {};
        checkAdviced(new HelloToby(), classMethodPointcut, true);
    }

    private void checkAdviced(HelloTarget target, Pointcut pointcut, boolean adviced) {
        ProxyFactoryBean pfBean = new ProxyFactoryBean();
        pfBean.setTarget(target);
        pfBean.addAdvisor(new DefaultPointcutAdvisor(pointcut, new UppercaseAdvice()));
        Hello proxiedHello = (Hello) pfBean.getObject();

        if (adviced) {
            assertThat(proxiedHello.sayHello("Toby"), is("HELLO TOBY"));
            assertThat(proxiedHello.sayHi("Toby"), is("HI TOBY"));
            assertThat(proxiedHello.sayThankYou("Toby"), is("Thank You Toby"));
        } else {
            assertThat(proxiedHello.sayHello("Toby"), is("Hello Toby"));
            assertThat(proxiedHello.sayHi("Toby"), is("Hi Toby"));
            assertThat(proxiedHello.sayThankYou("Toby"), is("Thank You Toby"));
        }
    }
    // ...
}
```

- 포인트컷이 클래스 필터까지 동작해서 클래스를 걸러버리면 프록시를 적용했다 하더라도 부가기능이 제공되지 않는다.

---
[목록](./index.md)
