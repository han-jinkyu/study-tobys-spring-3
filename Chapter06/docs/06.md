# 6. 트랜잭션 속성

- `DefaultTransactionDefinition`의 용도를 살펴본다.

## 6.1 트랜잭션 정의

- `TransactionDefinition` 인터페이스는 트랜잭션의 동작방식에 영향을 줄 수 있는 네 가지 속성을 정의하고 있다.

### 트랜잭션 전파

- `트랜잭션 전파(transaction propagation)`란 트랜잭션의 경계에서 이미 진행 중인 트랜잭션이 있을 때 어떻게 동작할 것인가를 결정하는 방식을 말한다.
- 만약 A 트랜잭션이 시작되고 끝나지 않은 시점에 B 트랜잭션이 호출된다면 B의 코드는 어떤 트랜잭션 안에서 동작할 것인가?
- 대표적으로 다음과 같은 트랜잭션 전파 속성을 줄 수 있다.
    - `PROPAGATION_REQUIRED`: 가장 많이 사용되는 전파 속성. 진행 중인 트랜잭션이 없으면 새로 시작하고, 있다면 이에 참여한다. `DefaultTransactionDefinition`의 전파 속성이 이에 해당한다.
    - `PROPAGATION_REQUIRES_NEW`: 항상 새로운 트랜잭션을 시작한다.
    - `PROPAGATION_NOT_SUPPORTED`: 트랜잭션 없이 동작하도록 만들 수 있다. 진행 중인 트랜잭션이 있어도 무시한다. 이는 복잡한 포인트컷을 만드는 것보다 간단하게 트랜잭션을 제외할 때 사용한다. 
- `getTransaction()` 메서드를 사용하는 이유는 트랜잭션 전파 속성을 가지고 특정 상황에 맞는 트랜잭션을 이용하기 위해서다.

### 격리수준

- 모든 DB 트랜잭션은 `격리수준(isolation level)`을 갖고 있어야 한다.
- 적절한 격리 수준으로 가능한 한 많은 트랜잭션을 동시에 진행하기 위해서다.
- `DefaultTransactionDefinition`에 설정된 격리수준은 `ISOLATION_DEFAULT`다. 이는 `DataSource`에 설정되어 있는 디폴트 격리수준을 그대로 따른다는 뜻이다.

### 제한시간

- 트랜잭션을 수행하는 `제한시간(timeout)`을 설정할 수 있다.
- `DefaultTransactionDefinition`의 기본 설정은 제한시간이 없는 것이다.
- 제한시간은 트랜잭션을 직접 시작할 수 있는 `PROPAGATION_REQUIRED`나 `PROPAGATION_REQUIRES_NEW`와 함께 사용해야만 의미가 있다.

### 읽기전용

- `읽기전용(read only)`으로 설정하면 트랜잭션 내에서 데이터를 조작하는 시도를 막아줄 수 있고, 데이터 액세스 기술에 따라서 성능이 향상될 수 있다.
- `TransactionDefinition` 타입 오브젝트를 사용하려면 네 가지 속성을 이용해 트랜잭션의 동작방식을 제어할 수 있다.
- 트랜잭션 정의를 수정하려면 트랜잭션 경계를 설정하는 `TransactionAdvice`에 `TransactionDefinition` 오브젝트를 DI 받아서 사용하도록 변경하면 된다.

## 6.2 트랜잭션 인터셉터와 트랜잭션 속성

- 메서드 별 다른 트랜잭션 정의를 적용하려면 어드바이스의 기능을 확장해야 한다.
- 초기에 `Transactionhandler`에서 메서드 이름을 이용해 트랜잭션 적용 여부를 판단했던 것과 비슷한 방식을 사용하면 된다.

### TransactionInterceptor

- 스프링에는 편리하게 트랜잭션 경계설정 어드바이스로 사용할 수 있도록 만들어진 `TransactionInterceptor`가 존재한다.
- `TransactionInterceptor`는 `TransactionAdvice`와 다르지 않으나, 트랜잭션 정의를 메서드 이름 패턴을 이요해서 다르게 지정할 수 있는 방법을 추가로 제공해준다.
- `PlatformTransactionManager`와 `Properties` 타입의 두 가지 프로퍼티를 가진다.
- `Properties` 타입인 프로퍼티의 이름은 `transactionAttributes`로, 트랜잭션 속성을 정의한 프로퍼티다.
- 트랜잭션 속성은 `TransactionDefinition`의 네 가지 기본 항목에 `rollbackOn()`이라는 메서드를 하나 더 갖고 있는 `TransactionAttribute` 인터페이스로 정의된다.
- `TransactionAdvice`는 `RuntimeException`이 발생할 떄만 롤백을 하기 때문에 체크예외를 사용하는 타깃이라면 트랜잭션이 제대로 롤백되지 않는 문제가 발생한다.
- 스프링이 제공하는 `TransactionInterceptor`는 기본적으로 두 가지 종류의 예외처리 방식이 있다. 런타임 예외가 발생하면 롤백하고 체크 예외라면 이를 의미 있는 리턴 방식의 한 가지로 인식하여 커밋한다.
- 그렇지만 이러한 예외처리 기본 원칙을 따르지 않는 경우가 있을 수 있다. 그래서 `rollbackOn()`이라는 속성을 둬서 기본 원칙과 다른 예외처리가 가능하게 한다.
- `Properties`라는 맵 타입 오브젝트로 `TransactionAttribute`를 전달 받아 메서드 패턴마다 각기 다른 트랜잭션 속성을 부여할 수 있다.

---
[목록](./index.md)
