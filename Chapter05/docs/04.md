# 4. 메일 서비스 추상화

## 4.1 JavaMail을 이용한 메일 발송 기능

- DB의 `User` 테이블에 email 필드를 추가하고 `User` 클래스에 email 프로퍼티를 추가한다.
- `UserDao`의 `userMapper`와 `insert()`, `update()`에 email 필드 처리 코드를 추가한다.
- `User` 생성자가 email을 받을 수 있게 하고, 테스트 데이터를 맞게 준비한 뒤등록과 수정, 조회에서 값이 잘 처리되도록 `UserDaoTest`를 수정한다.

### JavaMail 메일 발송

- 자바에서 메일을 발송할 때는 표준 기술인 JavaMail을 사용한다. (javax.mail 패키지)
- `upgradeLevel()`에서 메일 발송 메서드를 호출한다.

```java
public class UserService {
    // ...
    protected void upgradeLevel(User user) {
        user.upgradeLevel();
        userDao.update(user);
        sendUpgradeEMail(user);
    }

    private void sendUpgradeEMail(User user) {
        Properties props = new Properties();
        props.put("mail.smtp.host", "mail.ksug.org");
        Session session = Session.getInstance(props);

        MimeMessage message = new MimeMessage(session);
        try {
            message.setFrom(new InternetAddress("useradmin@ksug.org"));
            message.addRecipient(Message.RecipientType.TO,
                    new InternetAddress(user.getEmail()));
            message.setSubject("Upgrade 안내");
            message.setText("사용자님의 등급이 " + user.getLevel().name() + "로 업그레이드되었습니다.");

            Transport.send(message);
        } catch (AddressException e) {
            throw new RuntimeException(e);
        } catch (MessagingException e) {
            throw new RuntimeException(e);
        }
    }
    // ...
}
```

---
[목록](./index.md)
