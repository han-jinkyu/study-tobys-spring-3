# 2. 트랜잭션 서비스 추상화

- 정기 사용자 레벨 관리 작업을 수행하는 도중 문제가 발생해서 완료하지 못 하면, 그때까지 변경된 사용자 레벨은 그대로 둘까, 아니면 되돌려 놓아야 할까?

## 2-1. 모 아니면 도

- 테스트를 만들어 확인해 본다.
- 사람이 간섭하는 테스트가 아닌 장애가 발생했을 때 일어나는 현상 중 하나인 예외가 던져지는 상황을 의도적으로 만들어 본다.

### 테스트용 UserService 대역

- 작업 중간에 예외가 발생하도록 하는 가장 쉬운 방법은 예외를 강제로 발생시키도록 애플리케이션 코드를 수정하는 것이다.
- 다만 이를 위해서 애플리케이션 코드를 건들일 수 없으므로 테스트용으로 만든 UserService의 대역을 사용한다.
- UserService를 상속한 클래스를 작성하고 필요한 것만 오버라이딩한다.
- 테스트를 위해 `upgradeLevel()`은 `protected`로 변경한다.

```java
public class UserServiceTest {
    // ...
    static class TestUserService extends UserService {
        private String id;

        private TestUserService(String id) {
            this.id = id;
        }

        @Override
        protected void upgradeLevel(User user) {
            if (user.getId().equals(id)) throw new TestUserServiceException();
            super.upgradeLevel(user);
        }

    }

    static class TestUserServiceException extends RuntimeException {
    }
}
```

### 강제 예외 발생을 통한 테스트

```java
public class UserServiceTest {
    // ...
    @Test
    public void upgradeAllOrNothing() {
        UserService testUserService = new TestUserService(users.get(3).getId());
        testUserService.setUserDao(this.userDao);
        // Policy는 내가 실습한 내용
        testUserService.setUserLevelUpgradePolicy(this.userService.userLevelUpgradePolicy);

        userDao.deleteAll();
        for(User user : users) userDao.add(user);

        try {
            testUserService.upgradeLevels();
            fail("TestUserServiceException expected");
        } catch (TestUserServiceException e) {
        }

        checkLevelUpgraded(users.get(1), false);
    }
    // ...
}
```

- 다음과 같은 에러가 뜨며 테스트가 실패한다. 두 번째 사용자는 BASIC에서 SILVER로 바뀐 것이 유지되고 있다는 뜻이다.

```
java.lang.AssertionError: 
Expected: is <BASIC>
     but: was <SILVER>
Expected :is <BASIC>
Actual   :<SILVER>
```

### 테스트 실패의 원인

- 두 번째 유저가 갱신된 이유는 트랜잭션 문제다.

---
[목록](./index.md)
