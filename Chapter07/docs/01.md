# 1. SQL과 DAO의 분리

- `UserDao`에서 **DB 테이블과 필드정보를 고스란히 담고 있는 SQL 문장**을 DAO로부터 분리해본다.
- 데이터 액세스 로직은 바뀌지 않더라도 DB의 테이블, 필드 이름과 SQL 문장이 바뀔 수 있다.

## 1.1 XML 설정을 이용한 분리

- 가장 손쉽게 생각해볼 수 있는 SQL 분리 방법은 SQL을 스프링의 XML 설정파일로 뺴내는 것이다.

### 개별 SQL 프로퍼티 방식

- `UserDao`의 구현 클래스인 `UserDaoJdbc`에는 6개의 SQL 문장이 있다. `UserDaoJdbc` 클래스의 SQL 6개를 프로퍼티로 만들고 이를 XML로 지정하도록 해본다.
- 먼저 `add()` 메서드에 사용할 SQL을 프로퍼티로 정의한다.

```java
public class UserDaoJdbc implements UserDao {
    private String sqlAdd;

    public void setSqlAdd(String sqlAdd) {
        this.sqlAdd = sqlAdd;
    }

    // ...
}
```

- 그리고 `add()` 메서드의 SQL 문장을 제거하고 외부로부터 DI 받은 SQL 문장을 담은 `sqlAdd`를 사용하게 한다.

```java
public class UserDaoJdbc implements UserDao {
    // ...
    @Override
    public void add(final User user) {
        this.jdbcTemplate.update(
            this.sqlAdd,
            user.getId(), user.getName(), user.getPassword(),
            user.getLevel().intValue(), user.getLogin(), user.getRecommend(), user.getEmail());
    }
    // ...
}
```

- 다음은 XML 설정의 `userDao` 빈에 `sqlAdd` 프로퍼티를 추가하고 SQL을 넣어준다.

```xml
<!-- userDao -->
<bean id="userDao" class="springbook.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlAdd" value="INSERT INTO users(id, name, password, level, login, recommend, email) VALUES(?, ?, ?, ?, ?, ?, ?)" />
</bean>
```

- `UserDaoTest`를 실행하여 아무런 문제 없이 동작하는지 확인해본다.
- 이제 다른 쿼리도 테스트를 실행해 문제는 없는지 확인하면서 XML로 옮겨본다.

### SQL 맵 프로퍼티 방식

- SQL이 점점 많아지면 그때마다 DAO에 DI용 프로퍼티를 추가하기가 상당히 귀찮다.
- 따라서 SQL을 하나의 컬렉션으로 담아두는 방법을 시도해본다.
- `UserDao`에서 SQL을 주입받기 위해 개별적으로 정의한 프로퍼티를 모두 제거하고 `Map` 타입의 `sqlMap` 프로퍼티를 추가한다.

```java
public class UserDaoJdbc implements UserDao {
    private Map<String, String> sqlMap;

    public void setSqlMap(Map<String, String> sqlMap) {
        this.sqlMap = sqlMap;
    }
    // ...
}
```

- 각 메서드에는 미리 정해진 키 값을 이용해 `sqlMap`으로부터 SQL을 가져와 사용하도록 만든다.

```java
public class UserDaoJdbc implements UserDao {
    // ...
    @Override
    public void add(final User user) {
        this.jdbcTemplate.update(
            this.sqlMap.get("add"), // <- 이곳처럼 바꾼다
            user.getId(), user.getName(), user.getPassword(),
            user.getLevel().intValue(), user.getLogin(), user.getRecommend(), user.getEmail());
    }
    // ...
}
```

- 이제 XML을 수정한다. `Map`은 하나 이상의 정보를 담고 있기 때문에 `<property>`의 `value` 애트리뷰트로는 정의할 수 없다.
- 이때는 스프링에서 제공하는 `<map>` 태그를 사용해야 한다.

```xml
<!-- userDao -->
<bean id="userDao" class="springbook.user.dao.UserDaoJdbc">
    <property name="dataSource" ref="dataSource" />
    <property name="sqlMap">
        <map>
            <entry key="add" value="INSERT INTO users(id, name, password, level, login, recommend, email) VALUES(?, ?, ?, ?, ?, ?, ?)" />
            <entry key="get" value="SELECT * FROM users WHERE id = ?" />
            <entry key="deleteAll" value="DELETE FROM users" />
            <entry key="getCount" value="SELECT COUNT(*) FROM users" />
            <entry key="getAll" value="SELECT * FROM users ORDER BY id" />
            <entry key="update" value="UPDATE users SET name = ?, password = ?, level = ?, login = ?, recommend = ?, email = ? WHERE id = ?" />
        </map>
    </property>
</bean>
````

---
[Home](./index.md)
