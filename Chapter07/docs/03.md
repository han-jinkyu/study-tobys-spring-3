# 3. 서비스 추상화 적용

- `JaxbXmlSqlReader`는 다음 두 가지의 개선 여지를 생각해볼 수 있다.
    1. **자바에는 JAXB 외에도 다양한 XMl-오브젝트 매핑 기술이 존재**한다. 필요에 따라 다른 기술로 손쉽게 바꿔서 사용해야 한다.
    2. **XML 파일을 좀 더 다양한 소스에서 가져올 수 있게** 만든다. 임의의 클래스패스나 파일 시스템 상의 절대위치 또는 HTTP 프로토콜을 통해 원격에서 가져오도록 확장할 수 있는가 하는 점이다.


## 3.1 OXM 서비스 추상화

- JAXB 외에도 실전에서 자주 사용되는 XML과 자바오브젝트 매핑 기술이 있다.
    1. `Castor XML`: 매우 간결하고 가벼운 바인딩 프레임워크.
    2. `JiBX`: 뛰어난 퍼포먼스를 자랑하는 XML 바인딩 기술.
    3. `XmlBeans`: 아파치 XML 프로젝트 중 하나며, XML의 정보셋을 효과적으로 제공해준다.
    4. `Xstream`: 관례를 이용해 설정이 없는 바인딩을 지원하는 기술.
- 이렇게 XML과 자바오브젝트를 매핑해서 상호 변환해주는 기술을 간단히 `OXM(Object-XML Mapping)`이라 한다.
- JAXB를 포함한 다섯 기술은 사용 목적이 동일하기 때문에 유사한 기능과 API를 제공한다.
- 로우레벨의 구체적인 기술과 API에 종속되지 않고 추상화된 레이어와 API를 제공해서 구현 기술에 대해 독립적인 코드를 작성할 수 있게 해주는 **서비스 추상화**가 필요하다.
- 스프링이 제공하는 OXM 추상 계층의 API를 이용해 XML 문서와 오브젝트 사이의 변환을 처리하면, 코드 수정 없이 OXM 기술을 자유롭게 바꿔 적용할 수 있다. 또한 추상 인터페이스를 제공하기 때문에 테스트 작성이 편리하다.

### OXM 서비스 인터페이스

- `SqlReader`는 XML을 오브젝트로 변환하는 `Unmarshaller`를 이용하면 된다.
- `Unmarshaller` 인터페이스는 간단한데, XML 파일 정보를 담은 `Source` 타입 오브젝트를 주면, 설정에서 지정한 OXM 기술을 이용해 자바오브젝트 트리로 변환하고 루트 오브젝트를 돌려준다.
- OXM 기술에 따라 `Unmarshaller` 인터페이스를 구현한 다섯 가지 클래스가 있으며, 각 클래스는 해당 기술에서 필요로 하는 추가 정보를 빈 프로퍼티로 지정할 수 있게 되어 있다.

### JAXB 구현 테스트

- 학습 테스트인 `JaxtTest`를 스프링의 OXM 서비스 추상화 인터페이스를 이용하도록 만들어본다.
- JAXB를 이용하여 만들어진 `Unmarshaller` 구현 클래스는 `Jaxb2Marshaller`다. `Jaxb2Marshaller`는 `Marshaller`와 `Unmarshaller` 인터페이스를 모두 구현하고 있다.
- `Jaxb2Marshaller` 클래스를 빈으로 등록하고 바인딩 클래스의 패키지 이름을 지정하는 프로퍼티인 `contextPath`만 넣어주면 된다.
- `OxmTest-context.xml`이란 파일을 만들고 JAXB 언마샬러를 등록한 빈 설정을 작성한다.

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
                        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
    <bean id="unmarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
        <property name="contextPath" value="springbook.user.sqlservice.jaxb" />
    </bean>
</beans>
```

- `unmarshaller` 빈은 `Unmarshaller` 타입이므로 `@Autowired`를 이용해 빈을 가져올 수 있다.
- 스프링의 서비스 추상화가 적용됐으므로 로우레벨의 JAXB API를 사용해서 컨텍스트를 만들어 언마샬러를 생성하는 복잡한 코드를 작성할 필요가 없다.

```java
package springbook.learningtest.spring.oxm;

// ...
import org.springframework.oxm.Unmarshaller;
// ...

import javax.xml.transform.Source;
import javax.xml.transform.stream.StreamSource;
// ...

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration   // '클래스 이름' + '-context.xml' 파일을 사용하는 애플리케이션 컨텍스트 생성
public class OxmTest {
    @Autowired
    Unmarshaller unmarshaller;

    @Test
    public void unmarshallSqlMap() throws XmlMappingException, IOException {
        Source xmlSource = new StreamSource(
                getClass().getResourceAsStream("sqlmap.xml"));  // 파일은 같은 패키지로 복사

        Sqlmap sqlmap = (Sqlmap) this.unmarshaller.unmarshal(xmlSource);

        List<SqlType> sqlList = sqlmap.getSql();
        assertThat(sqlList.size(), is(3));
        assertThat(sqlList.get(0).getKey(), is("add"));
        assertThat(sqlList.get(1).getKey(), is("get"));
        assertThat(sqlList.get(2).getKey(), is("delete"));
    }
}
```

- 이 테스트 코드에는 JAXB라는 구체적인 기술에 의존하는 부분은 없다.
- OXM 추상화 계층을 이용했으므로 당연하며, 다른 기술로 바꾼다고 해도 테스트 코드를 바꿀 필요가 없다. XML의 빈 설정만 변경해주면 된다.

### Castor 구현 테스트 [Deprecated - 5.2.3에선 삭제되어서 직접 테스트는 불가했음]

- 이번엔 `Castor`로 OXM 기술을 변경해본다. `Castor`는 여러 가지 XML-오브젝트 변환 방법을 지원하는데, 그 중 간단하게 정의해서 사용할 수 있는 XML 매핑파일을 이용해본다.
- `Castor`에서 사용할 매핑정보를 담은 XML을 만들어 `mapping.xml`이라고 저장한다.

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapping PUBLIC "-//EXOLAB/Castor Mapping DTD Version 1.0//EN"
        "http://castor.org/mapping.dtd">
<mapping>
    <class name="springbook.user.sqlservice.jaxb.Sqlmap">
        <map-to xml="sqlmap" />
        <field name="sql" type="springbook.user.sqlservice.jaxb.SqlType"
            required="true" collection="arraylist">
            <bind-xml name="sql" node="element" />
        </field>
    </class>
    <class name="springbook.user.sqlservice.jaxb.SqlType">
        <map-to xml="sql" />
        <field name="key" type="string" required="true">
            <bind-xml name="key" node="attribute" />
        </field>
        <field name="value" type="string" required="true">
            <bind-xml node="text" />
        </field>
    </class>
</mapping>
```

- 다음은 설정파일의 `unmarshaller` 빈의 클래스를 `Castor`용 구현 클래스로 변경한다.

```xml
<bean id="unmarshaller" class="org.springframework.oxm.casotr.CastorMarshaller">
    <property name="mappingLocation" value="springbook/learningtest/spring/oxm/mapping.xml" />
</bean>
```

---
[Home](./index.md)
