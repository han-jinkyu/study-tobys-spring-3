# 6. 스프링 3.1의 DI

## 자바 언어의 변화와 스프링

- 자바 언어의 변화가 스프링에 준 영향 중 대표적인 두 가지 변화를 살펴본다.

### 애노테이션의 메타정보 활용

- 때로는 자바 코드가 다른 자바 코드에 의해 데이터처럼 취급되어, 자바 코드 일부를 리플렉션 API 등을 이용해 어떻게 만들었는지 살펴보고 그에 따라 동작하는 기능이 점점 많이 사용된다.
- 이런 프로그래밍 방식의 절정은 자바 5에 등장한 애노테이션이다.
- 애노테이션은 기존 자바 프로그래밍 방식으로는 직접 이용하지 못한다. 리플렉션 API를 이용해 메타정보를 조회하고 설정값을 참고하는 방법이 전부다.
- 애노테이션 활용이 늘어난 이유는 프레임워크가 참조하는 메타정보로 사용되기에 유리하기 때문이다.
- 애노테이션은 자바 코드의 일부이며, 코드 동작에 영향을 주지 않고 메타정보로 활용되는데 XML에 비해 유리한 점이 많다.
- XML로 표현하면 모든 내용을 명시적으로 작성해야 하나, 애노테이션은 간단하게 적용하고자 하는 위치에 코드를 작성하면 된다.

```xml
<x:special target="type" class="com.mycompany.myproject.MyClass" />
``` 

```java
package com.mycompany.myproject;

@Special
public class MyClass {
    // ...
}
```

- 리팩토링에서도 패키지를 변경하거나 클래스 이름을 바꿨다면, XML은 텍스트로 작성되기에 번거롭고 안전하지 않으나 애노테이션은 간단하다.
- 단점이라면, XML은 빌드를 거치지 않고 쉽게 편집이 가능하지만, 애노테이션은 매번 새로 컴파일해야 한다.
- 스프링 3.1부터는 XML을 완전히 배제하고 애노테이션만을 이용한 애플리케이션을 작성할 수 있다.

### 정책과 관례를 이용한 프로그래밍

- 메타정보를 활용하는 프로그래밍은 **관례를 따라 프로그램이 동작하게 하는 프로그래밍 스타일**을 적극적으로 시도해왔다.
- `DaoFactory` 같은 자바 코드를 대체한 스프링의 XML도 미리 정의한 정책을 이용한 것이다.
- 이런 방식은 자바 코드로 모든 것을 표현할 때보다 내용이 줄어든다는 장점이 있다.
- 반면 미리 정의된 관례를 기억해야 하고, 메타정보를 보고 프로그램이 어떻게 동작할지 이해해야 하는 부담을 준다.
- 루비 언어를 기반으로 한 RoR 프레임워크에 영향 받아, 관례를 이용해 작성해야 할 메타정보의 양을 최소화했다.
- 애노테이션을 이용하는 방식이 이러한 영향을 받은 하나이며, 명시적인 설정을 최대한 배제하면 코드가 간략해진다.
- `@Transactional`의 경우, 우선순위 정책을 모르면 의도대로 동작하지 않을 수 있다.
- 스프링은 점차 애노테이션으로 메타정보를 작성하고, 미리 정해진 정책과 관례를 활용해 간결한 코드에 많은 내용을 담는 방식을 적극 도입하고 있다.


## 6.1 자바 코드를 이용한 빈 설정

- 첫 번째는 XML을 없애고 애노테이션과 자바 코드로 대체한다.
- 책에 나온 의존성 리스트 가운데 `asm`은 5.2.3 버전이 없으므로 삭제했다.
- XML에 담긴 DI 정보는 스프링 테스트 컨텍스트를 이용하여 테스트를 작성할 때 쓴다.
- 단위 테스트에서는 컨텍스트가 필요 없기 때문에, `UserDaoTest`와 `UserServiceTest`만 신경 쓰면 된다.
- 테스트용으로 만들어진 기존 XML에서 애플리케이션이 운영환경에서 동작할 떄 필요한 DI 정보를 분리한다.

### 테스트 컨텍스트의 변경

- 가장 먼저 할 일은 테스트 코드에서 'DI 정보를 담는 XML의 위치를 정의한 코드'를 'DI 정보를 담는 자바 코드'로 변경하는 것이다.

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "classpath:test-applicationContext.xml")  // <- 이 코드
public class UserDaoTest {
    // ...
}
```

- 먼저 DI 정보로 사용될 자바 클래스를 만들어야 한다. 이는 클래스 위에 `@Configuration` 애노테이션을 달면 된다.

```java
@Configuration
public class TestApplicationContext {
}
```

- `@Configuration` 클래스가 준비됐으니 이제 `UserDaoTest`와 `UserServiceTest`가 이를 사용하도록 변경한다.

```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(classes = TestApplicationContext.class)
public class UserDaoTest {
    // ...
}
```

- 이제 테스트를 실행하면 전부 실패한다. 이 때 한 번에 XML에 있던 빈 설정을 모두 옮기는 건 부담이니 일단 XML의 도움을 받도록 만든다.

```java
@Configuration
@ImportResource(locations = "classpath:test-applicationContext.xml")
public class TestApplicationContext {
}
```

- 위와 같이 설정하면 테스트가 모두 성공한다.
- 미처 옮기지 못한 내용은 XML에 남겨두고 전환 작업을 실행한다. XML에 더이상 정보가 남지 않으면 `@ImportResource`를 삭제하도록 한다.

---
[Home](./index.md)
