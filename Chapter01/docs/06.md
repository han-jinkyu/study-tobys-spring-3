# 6. 싱글톤 레지스트리와 오브젝트 스코프

- 지금까지의 내용만 보면 DaoFactory와 @Configuration 애노테이션을 추가해서 스프링의 애플리케이션 컨텍스트를 통해 사용하는 것은 동일해 보인다.
- 하지만 스프링 애플리케이션 컨텍스트는 기존에 직접 만들었던 오브젝트 팩토리와는 중요한 차이점이 있다.
    - DaoFactory의 userDao() 메서드를 여러 번 호출할 때 오브젝트는 서로 다르다.
    - 애플리케이션 컨텍스트를 이요하여 DaoFactory를 설정 정보로 등록한 뒤 getBean() 메서드를 이용해 가져오는 오브젝트는 `동일`하다. 

## 6.1 싱글톤 레지스트리로서의 애플리케이션 컨텍스트

- 애플리케이션 컨텍스트는 우리가 만든 오브젝트 팩토리와 유사하게 동작한다.
- 그와 동시에 싱글톤을 저장하고 관리하는 `싱글톤 레지스트리(singleton registry)`다.
    - 즉 별다른 설정을 하지 않으면 내부에서 생성하는 빈 오브젝트를 모두 싱글톤으로 만든다.

### 서버 애플리케이션과 싱글톤

- 싱글톤으로 빈을 만드는 이유는 '스프링이 주로 적용되는 대상이 자바 엔터프라이즈 기술'을 사용하는 서버 환경이기 때문이다.
- 대규모인 엔터프라이즈 서버환경에서 매번 오브젝트를 만들어서 사용한다면 GC에 부하가 걸린다.
- 그래서 엔터프라이즈 분야에서는 `서비스 오브젝트`라는 개념을 일찍부터 사용해왔다.
    - 서블릿은 대부분 멀티스레드 환경에서 싱글톤으로 동작한다.
    - 서블릿 클래스당 하나의 오브젝트만 만들어두고 사용자의 요청을 담당하는 여러 스레드에서 공유한다.
- 디자인 패턴에서 소개된 싱글턴 패턴은 사용하기 까다롭고 여러 문제점이 있다.
    - 싱글턴 패턴 중 피해야 할 `안티 패턴(anti pattern)`이 존재하기도 한다.

### 싱글톤 패턴의 한계

일반적인 싱글톤 패턴 구현 방식에는 다음과 같은 문제가 있다.

- private 생성자를 갖고 있기 때문에 상속할 수 없다.
- 싱글톤은 테스트하기가 힘들다.
- 서버환경에서는 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.
- 싱글톤의 사용은 전역 상태를 만들 수 있기 때문에 바람직하지 못하다.

### 싱글톤 레지스트리

- 자바의 기본적 싱글톤 구현은 단점이 존재하므로 스프링은 직접 싱글톤 형태의 오브젝트를 만들고 관리한다.
    - 이를 `싱글톤 레지스트리(singleton registry)`라 한다.
- 스프링 컨테이너는 싱글톤을 생성하고 관리하고 공금하는 `싱글톤 관리 컨테이너`이기도 하다.
- `싱글톤 레지스트리`의 장점은 평범한 자바 클래스를 싱글톤으로 활용하게 해준다는 점이다.
- 덕분에 테스트 환경에서 자유롭게 오브젝트를 만들 수 있고, 목 오브젝트로 대체하는 것도 간단하다.
- 스프링은 `IoC 컨테이너`일 뿐 아니라 `싱글톤 레지스트리`다.


## 6.2 싱글톤 오브젝트의 상태

- 싱글톤은 멀티스레드 환경이라면 여러 스레드가 동시에 접근할 수 있다.
    - 따라서 상태 관리에 주의를 기울여야 한다.
- 기본적으로 싱글톤이 멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우, 상태정보를 내부에 갖고 있지 않은 `무상태(stateless) 방식`으로 만들어져야 한다.
    - 다중 사용자의 요청을 한꺼번에 처리하는 스레드가 동시에 싱글톤 오브젝트의 인스턴스 변수를 수정하는 것은 매우 위험하다.
    - 따라서 싱글톤은 기본적으로 인스턴스 필드의 값을 변경하고 유지하는 `상태유지(stateful) 방식으로 만들지 않는다`.
- 상태가 없는 방식으로 만들려면 파라미터와 로컬 변수, 리턴 값 등을 이용하면 된다.
- 현재 UserDao에는 인스턴스 변수로 `ConnectionMaker 타입의 인스턴스`가 존재한다.
    - 하지만 이는 읽기 전용 정보이므로 문제되지 않는다.

## 6.3 스프링 빈의 스코프

- 스프링에서 빈이 생성되고, 존재하고, 적용되는 범위를 `빈의 스코프(scope)`라 한다.
    - 기본 스코프는 `싱글톤`이다.
- 싱글톤 스코프는 컨테이너 내에 한 개의 오브젝트만 만들어져서 제거하지 않는 한 유지된다.
- 싱글톤 외에 다른 스코프도 존재한다.
    - `프로토타입(prototype)`: 매 요청마다 새로운 오브젝트를 생성한다.
    - `요청(request)`: 웹을 통해 새로운 HTTP 요청이 생길 때마다 생성한다.
    - `세션(session)`: 웹의 세션과 스코프가 유사하다.
    - 그 외에도 존재한다.

---
[목록](./index.md)
