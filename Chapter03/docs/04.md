# 4. 컨텍스트와 DI

## 4.1 JdbcContext의 분리

- 이제까지 변경한 내용을 전략 패턴 구조로 보면 다음과 같다.
    - UserDao의 메서드: 클라이언트
    - 익명 내부 클래스: 개별 전략
    - jdbcContextWithStatementStrategy(): 컨텍스트
- jdbcContextWithStatementStrategy() 메서드는 다른 DAO에서도 사용 가능하다.
- 따라서 UserDao로부터 독립시켜 본다.

### 클래스 분리

```java
public class JdbcContext {
    private DataSource dataSource;

    public JdbcContext(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void workWithStatementStrategy(StatementStrategy stmt) throws SQLException {
        Connection c = null;
        PreparedStatement ps = null;

        try {
            c = dataSource.getConnection();

            ps = stmt.makePreparedStatement(c);

            ps.executeUpdate();
        } catch (Exception e) {
            throw e;
        } finally {
            if (ps != null) {
                try {
                    ps.close();
                } catch (SQLException e) {
                    // pass
                }
            }

            if (c != null) {
                try {
                    c.close();
                } catch (SQLException e) {
                    // pass
                }
            }
        }
    }
}
```

```java
public class UserDao {
    // ...
    private JdbcContext jdbcContext;

    // ...
    public void setJdbcContext(JdbcContext jdbcContext) {
        this.jdbcContext = jdbcContext;
    }

    public void add(final User user) throws SQLException {
        jdbcContext.workWithStatementStrategy(c -> { /* ... */ });
    }
    // ...
}
```

### 빈 의존관계 변경

- UserDao는 JdbcContext에 의존한다.
- JdbcContext는 DataSource와 달리 구현된 구체 클래스다.
- 스프링의 DI는 기본적으로 인터페이스를 사이에 두고 의존 클래스를 바꿔 사용하도록 하는 게 목적이다.
- 하지만 이 경우엔 내용이 구현 방법이 바뀔 가능성이 없으므로 인터페이스는 생략한다.

```xml
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- dataSource -->
    <bean id="dataSource" class="org.springframework.jdbc.datasource.SimpleDriverDataSource">
        <!-- ... -->
    </bean>

    <!-- jdbcContext -->
    <bean id="jdbcContext" class="springbook.user.dao.JdbcContext">
        <property name="dataSource" ref="dataSource" />
    </bean>

    <!-- userDao -->
    <bean id="userDao" class="springbook.user.dao.UserDao">
        <property name="dataSource" ref="dataSource" />
        <property name="jdbcContext" ref="jdbcContext" />
    </bean>
</beans>
```

---
[목록](./index.md)
